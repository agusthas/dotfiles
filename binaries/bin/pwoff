#!/usr/bin/env bash

# Description
# -----------
# Wrapper around poweroff.

# Check if docker installed
if command -v docker >/dev/null 2>&1; then
  # Check if there are any containers running
  if [ "$(docker ps -q)" ]; then
    echo "There are still running containers. Please stop them before shutting down."
    docker ps --filter status=running --format "{{.ID}}: {{.Names}}"
    echo

    # Check if docker compose v2 installed
    if docker compose >/dev/null 2>&1; then
      read -p "Do you want me to shut them down? [y/N] " -n 1 -r
      echo

      [[ $REPLY =~ ^[Yy]$ ]] && for composed in $(docker compose ls -q); do docker compose -p "$composed" down; done || exit 1
    fi
  fi
fi

echo "Turning off in 3 seconds..."
sleep 3
sudo poweroff
