#!/usr/bin/env bash

display_usage() {
  echo "Usage: $0 [install|remove] <base-query>"
}

if ! type fzf >/dev/null; then
  exit 1
fi

declare -a packages

option="$1"
shift
if [ $option == 'install' ]; then
  apt_cmd="apt-get install"
  packages=($(apt-cache search . | sed 's/\ -.*//' | fzf --query "$1" --height 100% --multi --info=inline --preview 'apt-cache show {}'))
elif [ "$option" == "remove" ]; then
  apt_cmd="apt-get purge"
  packages=($(dpkg --get-selections | awk '{print $1}' | fzf --query "$1" --height 100% --multi --info=inline --preview 'apt-cache show {}'))
else
  display_usage
  exit 1
fi

echo "Packages to ${option}:" "${packages[@]}"
printf "Are you sure? [y/N] "
read -r answer
[[ "$answer" =~ ^[Yy]$ ]] || exit 0

if [ "$option" == 'install' ]; then
  sudo apt-get -qq update && sudo apt-get -qq upgrade
fi

sudo $apt_cmd "${packages[@]}" -y
