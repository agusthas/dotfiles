#!/usr/bin/env bash

get_workspace() {
  if [[ $# -eq 1 ]]; then
    workspace="$1" && [[ "$workspace" == "." ]] && workspace="$(pwd)"
  else
    local exact=(
      "$HOME/dotfiles"
    )
    local recurse=(
      "$HOME/sandbox"
    )

    workspaces=(
      "${exact[@]}"
      "$(fd -p . "${recurse[@]}" --max-depth=1 -t d)"
    )

    workspace=$(
      printf '%s\n' "${workspaces[@]}" \
        | fzf --reverse --height=50% --no-info --prompt="Select a workspace: "
    )
  fi

  if [ -z "$workspace" ]; then
    exit 0
  fi
}

if ! type fzf fd >/dev/null; then
  exit 1
fi

get_workspace "$@"
selected_name=$(basename "$workspace" | tr . _)

# check if inside TMUX session
if [[ -n "$TMUX" ]]; then
  # check if session with selected name exists
  if tmux has-session -t "$selected_name" 2>/dev/null; then
    # attach to session
    tmux attach -t "$selected_name"
  else
    # create new detached session and switch to it
    tmux new-session -d -s "$selected_name" -c "$workspace" && tmux switch-client -t "$selected_name"
  fi
else
  # check if session with selected name exists
  if tmux has-session -t "$selected_name" 2>/dev/null; then
    # attach to session
    tmux attach -t "$selected_name"
  else
    # create new session
    tmux new-session -s "$selected_name" -c "$workspace"
  fi
fi