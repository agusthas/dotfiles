#!/usr/bin/env bash

# Must have git installed
if ! type git >/dev/null 2>&1; then
  echo "git is not installed"
  exit 1
fi

# Must be in a git repository
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Not in a git repository"
  exit 1
fi

# Prompt user for new branch name, with defaulting to the current branch name
old_branch_name=$(git rev-parse --abbrev-ref HEAD)
read -p "Enter new branch name (old: $old_branch_name): " new_branch_name
# exit if user enters an empty string or new branch name is the same as the old branch name
if [ -z "$new_branch_name" ] || [ "$new_branch_name" = "$old_branch_name" ]; then
  echo "New branch name cannot be empty or the same as the old branch name"
  exit 1
fi

echo "Renaming branch $old_branch_name to $new_branch_name"
echo

git branch -m "$old_branch_name" "$new_branch_name"

echo "Check if $old_branch_name have remote branch"

# Check current branch upstream
upstream_branch=$(git rev-parse --abbrev-ref --symbolic-full-name @{u})

if [ -z "$upstream_branch" ]; then
  echo "No upstream branch found"
  exit 0
fi

echo "Found upstream branch: $upstream_branch"
echo

read -p "Push $new_branch_name to remote (y/n)? " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
  echo "Pushing $new_branch_name to remote"
  git push origin :"$old_branch_name" $new_branch_name
  git push -u origin "$new_branch_name"
fi

echo
echo "Done!"