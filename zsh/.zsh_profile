#!/usr/bin/env zsh

## -- PATHS --
typeset -U path
path+=($HOME/bin)

export FZF_DEFAULT_OPTS="
--bind '?:toggle-preview,ctrl-d:preview-down,ctrl-u:preview-up'
"
export FZF_DEFAULT_OPTS=$FZF_DEFAULT_OPTS"
--prompt='❯ '
--pointer='-'
--marker='+'
--tabstop=4
--color=dark
--color=hl:2:bold,fg+:4:bold,bg+:-1,hl+:2:bold,info:3:bold,border:8,prompt:2,pointer:5,marker:1,header:6
"
export FZF_COMPLETION_TRIGGER=','
function _fzf_compgen_path() {
  fd --hidden --follow --exclude ".git" . "$1"
}
function _fzf_compgen_dir() {
  fd --type d --hidden --follow --exclude ".git" . "$1"
}

## -- ALIASES --
alias :q="exit"
# alias getrandom='openssl rand -base64 32'

## -- FUNCTIONS --
function cap() { tee /tmp/capture.out; }
function ret() { cat /tmp/capture.out; }
# Tmux
# Kill server but with confirmation to kill all sessions
function tks() {
  if [[ -n $TMUX ]]; then
    echo "Still attached to tmux. Please detach first."
    return 1
  else
    # List active tmux sessions if any
    if tmux ls >/dev/null 2>&1; then
      echo "Active tmux sessions:"
      tmux ls
      printf "\n"

      echo -n "Do you want to kill the tmux server? [y/N] "
      read answer
    fi

    if [[ -z $answer || $answer =~ ^[Yy]$ ]]; then
      tmux kill-server
    fi
  fi
}

# npr
# Helper to run npm scripts, with fzf completion
function npr() {
  if [ $# -eq 0 ]; then
    echo "Usage: npr <script>" 2>&1
    return 1
  else
    npm run $@
  fi
}

_fzf_complete_npr() {
  setopt local_options no_aliases
  local package="./package.json"

  if [[ ! -f $package ]]; then
    return
  fi

  _fzf_complete --tiebreak=index -- "$@" < <(
    jq '.scripts | keys[]' $package -r 2>/dev/null
  )
}

bindkey -s ^f 'tms\n'
