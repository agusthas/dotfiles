#!/usr/bin/env zsh

## -- PATHS --
typeset -U path
path+=($HOME/bin)

export FZF_COMPLETION_TRIGGER=','
function _fzf_compgen_path() {
  fd --hidden --follow --exclude ".git" . "$1"
}
function _fzf_compgen_dir() {
  fd --type d --hidden --follow --exclude ".git" . "$1"
}

## -- ALIASES --
alias :q="exit"
alias ga="git add"
alias gba="git branch -a"
alias gst="git status"
alias gc="git commit -v"
alias groot='cd "$(git rev-parse --show-toplevel || echo .)"'
alias gwip='git add -A; git rm $(git ls-files --deleted) 2> /dev/null; git commit --no-verify --no-gpg-sign -m "--wip-- [skip ci]"'
alias gunwip='git log -n 1 | grep -q -c "\--wip--" && git reset HEAD~1'
alias glog="git log --graph --pretty=format:'%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)<%an>%Creset' --abbrev-commit --date=relative"
alias gsw="git switch"
alias gfo="git fetch origin"
alias gundo="git reset --soft HEAD~1"
# alias getrandom='openssl rand -base64 32'

## -- FUNCTIONS --
function n() {
  if ! type nnn > /dev/null 2>&1; then
    echo "nnn is not installed"
    return 1
  fi

  # Block nesting of nnn in subshells
  if [[ "${NNNLVL:-0}" -ge 1 ]]; then
    echo "nnn is already running"
    return
  fi

  export NNN_BMS="D:$HOME/Downloads;k:$HOME/koyoi;p:$HOME/p;s:$HOME/sandbox;h:$HOME"

  # The behaviour is set to cd on quit (nnn checks if NNN_TMPFILE is set)
  # If NNN_TMPFILE is set to a custom path, it must be exported for nnn to
  # see. To cd on quit only on ^G, remove the "export" and make sure not to
  # use a custom path, i.e. set NNN_TMPFILE *exactly* as follows:
  NNN_TMPFILE="${XDG_CONFIG_HOME:-$HOME/.config}/nnn/.lastd"

  # Unmask ^Q (, ^V etc.) (if required, see `stty -a`) to Quit nnn
  # stty start undef
  # stty stop undef
  # stty lwrap undef
  # stty lnext undef

  # The backslash allows one to alias n to nnn if desired without making an
  # infinitely recursive alias
  \nnn -ARJo "$@"

  if [ -f "$NNN_TMPFILE" ]; then
    . "$NNN_TMPFILE"
    rm -f "$NNN_TMPFILE" > /dev/null
  fi
}
